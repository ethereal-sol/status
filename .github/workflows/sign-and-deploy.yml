name: Sign configs and deploy Pages

on:
  push:
    branches: ["main"]
    paths:
      - "eth/**"
      - ".github/workflows/sign-and-deploy.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (PyNaCl + cryptography)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install pynacl cryptography

      - name: Sign all eth/**/config.json -> config.sig (base64, libsodium; uses PEM secret)
        shell: bash
        env:
          ED25519_PRIV_PEM_B64: ${{ secrets.ED25519_PRIV_PEM_B64 }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import os, base64
          from pathlib import Path

          from nacl.signing import SigningKey
          from cryptography.hazmat.primitives.serialization import (
              load_pem_private_key, Encoding, PrivateFormat, NoEncryption
          )
          from cryptography.hazmat.primitives.asymmetric.ed25519 import Ed25519PrivateKey

          b64 = (os.getenv("ED25519_PRIV_PEM_B64") or "").strip()
          if not b64:
              raise SystemExit("::error::Missing secret ED25519_PRIV_PEM_B64")

          try:
              pem = base64.b64decode(b64, validate=True)
          except Exception:
              raise SystemExit("::error::ED25519_PRIV_PEM_B64 is not valid base64")

          pem = pem.replace(b"\r\n", b"\n")

          key = load_pem_private_key(pem, password=None)
          if not isinstance(key, Ed25519PrivateKey):
              raise SystemExit("::error::PEM is not an Ed25519 private key")

          seed = key.private_bytes(Encoding.Raw, PrivateFormat.Raw, NoEncryption())
          sk = SigningKey(seed)

          cfgs = list(Path("eth").rglob("config.json"))
          if not cfgs:
              raise SystemExit("::error::No eth/**/config.json found")

          for cfg in cfgs:
              sig = sk.sign(cfg.read_bytes()).signature
              cfg.with_name("config.sig").write_text(
                  base64.b64encode(sig).decode("ascii"),
                  encoding="ascii"
              )
              print(f"Signed {cfg} -> {cfg.with_name('config.sig')}")
          PY

      - name: Debug tree (eth/)
        shell: bash
        run: |
          echo "=== Files that will be published (eth/) ==="
          find eth -type f -maxdepth 8 -print

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: eth/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
