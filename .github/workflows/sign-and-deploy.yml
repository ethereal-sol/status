name: Sign configs and deploy Pages

on:
  push:
    branches: ["main"]
    paths:
      - "eth/**"
      - ".github/workflows/sign-and-deploy.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore Ed25519 private key (from base64 secret)
        shell: bash
        run: |
          set -euo pipefail
          umask 077

          KEY_FILE="$(mktemp -p . ed25519_priv_XXXXXX.pem)"
          echo "KEY_FILE=$KEY_FILE" >> "$GITHUB_ENV"

          printf '%s' "${{ secrets.ED25519_PRIV_PEM_B64 }}" \
            | tr -d '\r' \
            | base64 --decode > "$KEY_FILE"

          chmod 600 "$KEY_FILE"

          head -n 1 "$KEY_FILE" | grep -q "BEGIN PRIVATE KEY" || {
            echo "::error::Secret is not a PEM private key (expected BEGIN PRIVATE KEY)."
            exit 1
          }

      - name: OpenSSL sanity check (providers + ed25519 support + key type)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::OpenSSL info"
          openssl version -a
          echo "::endgroup::"

          echo "::group::Providers"
          openssl list -providers || true
          echo "::endgroup::"

          echo "::group::Signature algorithms (ed25519 should exist)"
          openssl list -signature-algorithms 2>/dev/null | grep -i ed25519 || true
          echo "::endgroup::"

          echo "::group::Key type (public part)"
          openssl pkey -in "$KEY_FILE" -noout -text_pub | head -n 30
          echo "::endgroup::"

          openssl pkey -in "$KEY_FILE" -noout -text_pub | grep -qi "ED25519" || {
            echo "::error::Key is not ED25519 (check the secret)."
            exit 1
          }

      - name: Sign all eth/**/config.json -> config.sig (base64)
        shell: bash
        run: |
          set -euo pipefail

          export OPENSSL_CONF=/dev/null

          found=0

          while IFS= read -r -d '' CFG; do
            found=1
            DIR="$(dirname "$CFG")"
            SIGBIN="$DIR/config.sig.bin"
            SIGTXT="$DIR/config.sig"

            echo "::group::Signing $CFG"

            openssl pkeyutl \
              -provider default -provider base \
              -sign -rawin \
              -inkey "$KEY_FILE" \
              -in "$CFG" \
              -out "$SIGBIN"

            openssl base64 -A -in "$SIGBIN" -out "$SIGTXT"

            openssl pkey -in "$KEY_FILE" -pubout -out "$DIR/ed25519_pub.pem"
            openssl pkeyutl \
              -provider default -provider base \
              -verify -rawin \
              -pubin -inkey "$DIR/ed25519_pub.pem" \
              -in "$CFG" \
              -sigfile "$SIGBIN"

            rm -f "$SIGBIN" "$DIR/ed25519_pub.pem"

            echo "::endgroup::"
          done < <(find eth -type f -name "config.json" -print0)

          if [ "$found" -eq 0 ]; then
            echo "::error::No eth/**/config.json found to sign."
            exit 1
          fi

      - name: Cleanup private key
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${KEY_FILE:-}" ] && rm -f "$KEY_FILE" || true

      - name: Debug tree (eth/)
        shell: bash
        run: |
          echo "=== Files that will be published (eth/) ==="
          find eth -type f -maxdepth 6 -print

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: eth/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
