<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ethereal: Status</title>
  <meta name="color-scheme" content="dark" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050607;
      --border: rgba(255,255,255,.14);
      --border-2: rgba(255,255,255,.09);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);

      --radius: 22px;
      --shadow: 0 18px 55px rgba(0,0,0,.68);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --space: "Space Mono", var(--mono);

      --ok: rgba(255,255,255,.92);
      --ok-glow: rgba(255,255,255,.22);
      --ok-glow-strong: rgba(255,255,255,.34);
      --warn:#f59e0b;
      --part:#a78bfa;
      --down:#fb7185;
      --maint: rgba(255,255,255,.42);

      --sa-left: env(safe-area-inset-left);
      --sa-right: env(safe-area-inset-right);
      --safeX: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; width:100%; overflow-x: clip; }
    @supports not (overflow: clip){
      html,body{ overflow-x:hidden; }
    }

    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 70% 20%, rgba(255,255,255,.035), transparent 60%),
        radial-gradient(900px 700px at 20% 80%, rgba(255,255,255,.025), transparent 64%),
        var(--bg);
      color: var(--text);
      font-family: var(--sans);
      overflow-y:auto;
      -webkit-text-size-adjust: 100%;
    }

    canvas#bg{
      position:fixed;
      inset:0;
      z-index:0;
      width:100%;
      height:100%;
      pointer-events:none;
      opacity:.95;
    }

    .vignette{
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;
      background: radial-gradient(circle at 50% 45%, rgba(0,0,0,0), rgba(0,0,0,.62) 70%, rgba(0,0,0,.84) 100%);
    }

    .stage{
      position:relative;
      z-index:2;
      min-height: 100svh;
      display:flex;
      align-items:center;
      justify-content:center;

      --pad: clamp(16px, 3vw, 40px);

      padding-left: var(--safeX);
      padding-right: var(--safeX);
      padding-top: calc(var(--pad) + env(safe-area-inset-top));
      padding-bottom: calc(var(--pad) + env(safe-area-inset-bottom));
    }

    @media (max-height: 720px){
      .stage{ align-items:flex-start; }
    }

    .frame{
      position:relative;
      width:min(1100px, 100%);
      margin: 0 auto;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      overflow: visible;

      background: rgba(0,0,0,.52);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);

      opacity:0;
      transform: translateY(14px) scale(.99);
      animation: frameIn .75s cubic-bezier(.2,.9,.25,1) .12s forwards;
    }

    @keyframes frameIn{ to{ opacity:1; transform:none; } }

    .frame-inner{
      position:relative;
      padding: clamp(18px, 3vw, 34px);
      border-radius: var(--radius);
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      gap: 14px;
      flex-wrap: wrap;
    }

    h1{
      margin:0;
      font-size: clamp(28px, 3.2vw, 44px);
      line-height:1.05;
      letter-spacing:-0.02em;
      font-family: var(--space);
      font-weight: 300;
    }

    .sub{
      margin: 10px 0 0;
      color: var(--muted);
      font-size: clamp(14px, 1.4vw, 16px);
      line-height:1.55;
      max-width: 72ch;
      font-family: var(--space);
      font-weight: 400;
    }

    .actions{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
    }

    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      margin: 18px 0;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border-radius: 999px;
      padding: 12px 14px;
      min-height: 44px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.38);
      color: var(--text);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.50) inset,
        0 10px 26px rgba(0,0,0,.50);
      transition: transform .16s ease, border-color .16s ease, box-shadow .16s ease, filter .16s ease;
      touch-action: manipulation;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      user-select:none;
      font-weight: 700;
      letter-spacing:.01em;
    }

    .pill:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.30);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.50) inset,
        0 12px 30px rgba(0,0,0,.60);
    }

    .pill.btnlike{
      cursor:pointer;
    }

    .pill[aria-busy="true"]{
      filter: saturate(.7) brightness(.95);
      cursor: progress;
    }

    .pill input[type="checkbox"]{
      width: 16px;
      height: 16px;
      accent-color: #bdbdbd;
      transform: translateY(1px);
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      color: rgba(255,255,255,.35);
      background: currentColor;
      box-shadow: 0 0 0 2px rgba(255,255,255,.14);
      flex:0 0 auto;
    }

    .dot.pulse{
      animation: pulse 1.8s ease-out infinite;
    }

    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 currentColor, 0 0 0 2px rgba(255,255,255,.14); }
      100%{ box-shadow: 0 0 0 14px rgba(255,255,255,0), 0 0 0 2px rgba(255,255,255,.14); }
    }

    .sig{
      width:6px;
      height:22px;
      border-radius:999px;
      color: rgba(255,255,255,.35);
      background: currentColor;
      box-shadow: 0 0 0 1px rgba(255,255,255,.12);
      flex:0 0 auto;
    }

    .status-ok{
      color: var(--ok);
      text-shadow: 0 0 10px var(--ok-glow);
    }

    .dot.status-ok{
      box-shadow:
        0 0 0 2px rgba(255,255,255,.14),
        0 0 14px var(--ok-glow),
        0 0 26px rgba(255,255,255,.10);
    }

    .sig.status-ok{
      box-shadow:
        0 0 0 1px rgba(255,255,255,.12),
        0 0 16px var(--ok-glow-strong);
    }

    .status-ok{ color: var(--ok); }
    .status-warn{ color: var(--warn); }
    .status-part{ color: var(--part); }
    .status-down{ color: var(--down); }
    .status-maint{ color: var(--maint); }

    .banner{
      border: 1px solid var(--border-2);
      border-radius: var(--radius);
      background: rgba(10, 12, 16, .44);
      padding: 14px;
      position:relative;
      overflow: visible;
      display:flex;
      align-items:flex-start;
      gap: 12px;
    }

    .banner-title{
      margin:0;
      font-family: var(--space);
      font-weight: 700;
      letter-spacing:-0.01em;
      font-size: clamp(18px, 2.2vw, 24px);
      line-height:1.2;
    }

    .banner-desc{
      margin: 6px 0 0;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      line-height:1.6;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      align-items:start;
    }

    .grid > *{ width:100%; min-width:0; }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      .actions{ margin-left: 0; width:100%; justify-content:flex-start; }
      .pill{ flex: 1 1 auto; }
    }

    .card{
      border: 1px solid var(--border-2);
      border-radius: var(--radius);
      background: rgba(10, 12, 16, .44);
      padding: 14px;
      position:relative;
      overflow: visible;
    }

    .label{
      display:block;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.70);
      letter-spacing: .08em;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .item{
      display:flex;
      gap: 12px;
      align-items:center;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      padding: 12px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.45) inset;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
    }

    .item:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,.34);
      border-color: rgba(255,255,255,.20);
    }

    .item-main{ min-width:0; flex:1; }
    .item-title{
      font-weight: 800;
      font-size: 14px;
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-sub{
      margin-top: 4px;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.58);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.72);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      flex:0 0 auto;
      align-self:center;
      text-transform: capitalize;
      white-space: nowrap;
    }

    .inc{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      padding: 12px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.45) inset;
    }

    .inc + .inc{ margin-top: 10px; }

    .inc-head{
      display:flex;
      flex-wrap: wrap;
      align-items:center;
      gap: 10px;
    }

    .inc-title{
      margin:0;
      font-weight: 900;
      font-family: var(--space);
      letter-spacing:-0.01em;
      font-size: 16px;
      line-height:1.2;
      flex: 1 1 320px;
      min-width: 0;
    }

    .inc-meta{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.58);
      flex: 1 1 320px;
      min-width: 0;
      overflow-wrap:anywhere;
    }

    details{
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 10px;
    }

    details summary{
      cursor:pointer;
      color: rgba(255,255,255,.70);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.02em;
      user-select:none;
    }

    .updates{
      margin: 10px 0 0;
      padding: 0;
      list-style: none;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }

    .updates li{
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }

    .updates time{
      display:block;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.60);
      font-variant-numeric: tabular-nums;
      margin-bottom: 6px;
    }

    .muted{ color: var(--muted); }

    .skeleton{
      position:relative;
      overflow:hidden;
      background: rgba(255,255,255,.06);
      border-radius: 12px;
      height: 12px;
    }
    .skeleton::after{
      content:"";
      position:absolute;
      inset:0;
      transform:translateX(-100%);
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.14), rgba(255,255,255,0));
      animation: shimmer 1.3s infinite;
    }
    @keyframes shimmer{ 100%{ transform:translateX(100%); } }

    footer{
      margin-top: 16px;
      color: rgba(255,255,255,.54);
      text-align:center;
      font-family: var(--mono);
      font-size: 12px;
    }

    :focus-visible{
      outline: 2px solid rgba(255,255,255,.55);
      outline-offset: 3px;
    }

    @media (max-width: 520px){
      .frame{ border-radius: 18px; }
      .frame-inner{ padding: 16px; }
      .card, .banner{ border-radius: 18px; }
      .divider{ margin: 16px 0; }
    }

    @media (prefers-reduced-motion: reduce){
      .frame{ animation:none; opacity:1; transform:none; }
      .pill, .item{ transition:none; }
      .dot.pulse{ animation:none; }
      canvas#bg{ display:none; }
    }
  </style>
</head>

<body>
  <canvas id="bg" aria-hidden="true"></canvas>
  <div class="vignette" aria-hidden="true"></div>

  <main class="stage">
    <section class="frame" aria-label="Status">
      <div class="frame-inner">

        <div class="topbar">
          <div>
            <h1 data-i18n="title">Status</h1>
            <p class="sub" id="lastUpdated" data-i18n="loading">Loading…</p>
          </div>

          <div class="actions">
            <span class="pill" id="overallChip"><span class="dot"></span><span data-i18n="checking">Checking…</span></span>
            <button id="refreshBtn" class="pill btnlike" type="button" title="Refresh" data-i18n-title="refreshTitle">↻ <span data-i18n="refresh">Refresh</span></button>
            <label class="pill" title="Auto refresh" data-i18n-title="autoTitle">
              <input id="autoRefresh" type="checkbox">
              <span data-i18n="auto">auto</span>
            </label>
            <button id="langBtn" class="pill btnlike" type="button" title="Русский" aria-label="Toggle language">RU</button>
          </div>
        </div>

        <div class="divider"></div>

        <section class="banner" id="banner">
          <div style="min-width:0">
            <div class="banner-title" id="bannerText" data-i18n="loadingStatus">Loading status…</div>
            <div class="banner-desc" id="bannerDesc" data-i18n="fetching">Fetching data</div>
          </div>
        </section>

        <div class="divider"></div>

        <div class="grid">
          <section class="card">
            <span class="label" data-i18n="components">Components</span>
            <div id="components" class="list">
              <div class="item">
                <span class="skeleton" style="width:18px;height:18px;border-radius:999px"></span>
                <div class="item-main">
                  <div class="skeleton" style="width:40%"></div>
                  <div class="skeleton" style="width:30%;margin-top:6px"></div>
                </div>
              </div>
              <div class="item">
                <span class="skeleton" style="width:18px;height:18px;border-radius:999px"></span>
                <div class="item-main">
                  <div class="skeleton" style="width:50%"></div>
                  <div class="skeleton" style="width:25%;margin-top:6px"></div>
                </div>
              </div>
            </div>
          </section>

          <section class="card">
            <span class="label" data-i18n="incidents">Incidents</span>
            <div id="incidents">
              <div class="inc">
                <div class="skeleton" style="width:70%;height:18px"></div>
                <div class="skeleton" style="width:40%;margin-top:8px"></div>
              </div>
            </div>
          </section>
        </div>

        <footer id="footerText" data-i18n="footer"></footer>
      </div>
    </section>
  </main>

  <script>
    function applySafeX(){
      const root = document.documentElement;
      const cs = getComputedStyle(root);
      const left = parseFloat(cs.getPropertyValue("--sa-left")) || 0;
      const right = parseFloat(cs.getPropertyValue("--sa-right")) || 0;
      const base = 16;
      const x = Math.max(base, left, right);
      root.style.setProperty("--safeX", x + "px");
    }
    applySafeX();
    window.addEventListener("resize", applySafeX, { passive:true });
    window.addEventListener("orientationchange", applySafeX);
  </script>

  <script>
    const bg = document.getElementById("bg");
    const ctx = bg.getContext("2d", { alpha: false, desynchronized: true });

    const glyphs = "01{}[]();=>/\\*+-_#@~$<>|:^.,";
    const keywords = ["status::", "incident()", "uptime_90d", "operational", "monitoring", "resolved", "0xBEEF", "signal", "stack", "heap"];

    const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    const mqMobile = window.matchMedia("(max-width: 920px)");

    let columns = [];
    let fontSize = 14;
    let colWidth = 12;
    let lastT = 0;
    let monoFont = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";

    function rand(min,max){ return Math.random()*(max-min)+min; }
    function randi(min,max){ return Math.floor(rand(min, max+1)); }

    function resizeBg(){
      const DPR = Math.min(1.6, window.devicePixelRatio || 1);
      bg.width = Math.floor(innerWidth * DPR);
      bg.height = Math.floor(innerHeight * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);

      const cssW = innerWidth;
      const cssH = innerHeight;

      fontSize = mqMobile.matches ? 13 : 14;
      colWidth = Math.max(10, Math.floor(fontSize * 0.9));
      const cols = Math.floor(cssW / colWidth);

      monoFont = getComputedStyle(document.documentElement).getPropertyValue("--mono").trim() || monoFont;

      columns = Array.from({length: cols}, (_, i) => ({
        x: i * colWidth,
        y: rand(-cssH, 0),
        speed: rand(mqMobile.matches ? 38 : 55, mqMobile.matches ? 95 : 140),
        density: rand(0.45, 0.75),
        seed: Math.random() * 9999
      }));

      ctx.fillStyle = "#050607";
      ctx.fillRect(0,0,cssW,cssH);
    }

    function pickLine(){
      if(Math.random() < 0.08) return keywords[randi(0, keywords.length-1)];
      const len = randi(8, 22);
      let s = "";
      for(let i=0;i<len;i++) s += glyphs[randi(0, glyphs.length-1)];
      return s;
    }

    function draw(t){
      const cssW = innerWidth;
      const cssH = innerHeight;

      const targetFPS = reduceMotion ? 12 : (mqMobile.matches ? 40 : 60);
      const minDt = 1000 / targetFPS;

      if(!lastT) lastT = t;
      const dtMs = t - lastT;
      if(dtMs < minDt){
        requestAnimationFrame(draw);
        return;
      }
      const dt = Math.min(0.06, dtMs/1000);
      lastT = t;

      const fade = reduceMotion ? 0.18 : 0.10;
      ctx.fillStyle = `rgba(5,6,7,${fade})`;
      ctx.fillRect(0,0,cssW,cssH);

      ctx.font = `${fontSize}px ${monoFont}`;
      ctx.textBaseline = "top";

      for(const c of columns){
        c.y += c.speed * dt;
        if(Math.random() > c.density) continue;

        const line = pickLine();
        const alpha = rand(0.06, 0.16);
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;

        const jitter = Math.sin((t*0.001)+c.seed) * 0.6;
        ctx.fillText(line, c.x + jitter, c.y);

        if(c.y > cssH + 40){
          c.y = rand(-cssH*0.35, -20);
          c.speed = rand(mqMobile.matches ? 38 : 55, mqMobile.matches ? 95 : 140);
          c.density = rand(0.45, 0.75);
        }
      }

      requestAnimationFrame(draw);
    }

    let rq = false;
    window.addEventListener("resize", () => {
      if(rq) return;
      rq = true;
      requestAnimationFrame(() => {
        rq = false;
        resizeBg();
      });
    }, { passive:true });

    resizeBg();
    requestAnimationFrame(draw);
  </script>

  <script>
  (()=>{

    const $=s=>document.querySelector(s);

    const componentsEl = $('#components');
    const incidentsEl  = $('#incidents');

    const lastUpdatedEl = $('#lastUpdated');
    const bannerText = $('#bannerText');
    const bannerDesc = $('#bannerDesc');
    const bannerDot  = $('#bannerDot');

    const chip = $('#overallChip');
    const refreshBtn = $('#refreshBtn');
    const autoRefresh = $('#autoRefresh');
    const langBtn = $('#langBtn');

    const I18N = {
      en: {
        title: "Status",
        loading: "Loading…",
        checking: "Checking…",
        refresh: "Refresh",
        refreshTitle: "Refresh",
        auto: "auto",
        autoTitle: "Auto refresh",
        loadingStatus: "Loading status…",
        fetching: "Fetching data",
        components: "Components",
        incidents: "Incidents",
        footer: "",
        lastUpdate: "Last update:",
        failed: "Failed to load status.json",
        error: "Error",
        refreshing: "Refreshing…",
        noIncidents: "No incidents",
        updates: "Updates",
        noComponents: "No components",
        emptyList: "status.json returned empty list",
        couldNotLoad: "Could not load data",
        ongoing: "ongoing",
        affected: "Affected",
        since: "Last update:",
        relAgo: "ago",
        relIn: "in",
        relSec: "sec",
        relMin: "min",
        relH: "h",
        relD: "d",
        uptime90d: "90d uptime",
        overall: {
          ok: "All systems operational",
          minor: "Minor issues",
          partial: "Partial degradation",
          major: "Major issues",
          outage: "Global outage"
        },
        comp: {
          operational: "Operational",
          degraded: "Degraded",
          partial_outage: "Partial outage",
          major_outage: "Major outage",
          maintenance: "Maintenance",
          unknown: "Unknown"
        },
        upd: {
          investigating: "Investigating",
          identified: "Identified",
          monitoring: "Monitoring",
          resolved: "Resolved",
          in_progress: "In progress",
          completed: "Completed",
          update: "Update",
          status: "Status"
        },
        sev: {
          minor: "Minor",
          major: "Major",
          critical: "Critical",
          maintenance: "Maintenance",
          info: "Info"
        }
      },
      ru: {
        title: "Статус",
        loading: "Загрузка…",
        checking: "Проверяем…",
        refresh: "Обновить",
        refreshTitle: "Обновить",
        auto: "авто",
        autoTitle: "Автообновление",
        loadingStatus: "Грузим статус…",
        fetching: "Тянем данные",
        components: "Компоненты",
        incidents: "Инциденты",
        footer: "",
        lastUpdate: "Последнее обновление:",
        failed: "Не удалось загрузить status.json",
        error: "Ошибка",
        refreshing: "Обновляем…",
        noIncidents: "Инцидентов нет",
        updates: "Обновления",
        noComponents: "Компонентов нет",
        emptyList: "status.json вернул пустой список",
        couldNotLoad: "Данные не загрузились",
        ongoing: "в процессе",
        affected: "Затронуто",
        since: "Последнее обновление:",
        relAgo: "назад",
        relIn: "через",
        relSec: "сек",
        relMin: "мин",
        relH: "ч",
        relD: "д",
        uptime90d: "аптайм 90д",
        overall: {
          ok: "Все системы в норме",
          minor: "Мелкие проблемы",
          partial: "Частичная деградация",
          major: "Серьёзные проблемы",
          outage: "Глобальный отвал"
        },
        comp: {
          operational: "В норме",
          degraded: "Деградация",
          partial_outage: "Частичный отвал",
          major_outage: "Крупный отвал",
          maintenance: "Техработы",
          unknown: "Неизвестно"
        },
        upd: {
          investigating: "Разбираемся",
          identified: "Причина найдена",
          monitoring: "Наблюдаем",
          resolved: "Исправлено",
          in_progress: "В процессе",
          completed: "Завершено",
          update: "Апдейт",
          status: "Статус"
        },
        sev: {
          minor: "Минор",
          major: "Мажор",
          critical: "Крит",
          maintenance: "Техработы",
          info: "Инфо"
        }
      }
    };

    const COMP_RANK = { operational:0, degraded:1, partial_outage:2, major_outage:3, maintenance:1 };

    const compClass = s =>
      s==='operational'     ? 'status-ok'   :
      s==='degraded'        ? 'status-warn' :
      s==='partial_outage'  ? 'status-part' :
      s==='major_outage'    ? 'status-down' :
      s==='maintenance'     ? 'status-maint':
                              'status-ok';

    const storedLang = (localStorage.getItem("lang") || "").toLowerCase();
    let lang = (storedLang === "ru" || storedLang === "en")
      ? storedLang
      : ((navigator.language||"en").toLowerCase().startsWith("ru") ? "ru" : "en");

    let lastData = null;
    let ctrl = null;
    let inFlight = false;

    function t(){
      return I18N[lang] || I18N.en;
    }

    function applyI18n(){
      const dict = t();
      document.documentElement.lang = lang;

      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        if(dict[k] != null) el.textContent = dict[k];
      });

      document.querySelectorAll("[data-i18n-title]").forEach(el=>{
        const k = el.getAttribute("data-i18n-title");
        if(dict[k] != null) el.setAttribute("title", dict[k]);
      });

      langBtn.textContent = lang === "ru" ? "EN" : "RU";
      langBtn.setAttribute("title", lang === "ru" ? "English" : "Русский");
    }

    const mapOverall = s => {
      const dict = t().overall;
      const map = {
        ok:     ['status-ok', dict.ok],
        minor:  ['status-warn', dict.minor],
        partial:['status-part', dict.partial],
        major:  ['status-down', dict.major],
        outage: ['status-down', dict.outage]
      };
      return map[s] || ['status-ok', dict.ok];
    };

    const labelComp = s => {
      const dict = t().comp;
      return dict[s] || dict.unknown;
    };

    const labelUpd = s => {
      const dict = t().upd;
      return dict[s] || dict.status;
    };

    const fmt = d => {
      const time = d instanceof Date ? d : new Date(d);
      if(Number.isNaN(time.getTime())) return "";
      return time.toLocaleString(undefined,{
        year:'numeric',month:'short',day:'2-digit',
        hour:'2-digit',minute:'2-digit'
      });
    };

    const rel = d => {
      const dict = t();
      const tt = new Date(d).getTime();
      if(Number.isNaN(tt)) return "";
      const diff = Math.round((Date.now()-tt)/1000);
      const abs = Math.abs(diff);
      const u = abs<60   ? [dict.relSec,1] :
                abs<3600 ? [dict.relMin,60] :
                abs<86400? [dict.relH,3600]  :
                           [dict.relD,86400];
      const v = Math.floor(abs/u[1]);
      return diff>=0 ? `${v} ${u[0]} ${dict.relAgo}` : `${dict.relIn} ${v} ${u[0]}`;
    };

    const esc = s => String(s ?? "").replace(/[&<>"']/g,c=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]||c));

    const computeOverall = cs => {
      let w=0;
      for(const c of cs) w = Math.max(w, COMP_RANK[c.status] ?? 0);
      return w>=3 ? 'major' : w===2 ? 'partial' : w===1 ? 'minor' : 'ok';
    };

    function applyOverall(s, updated){
      const dict = t();
      const [cls, label] = mapOverall(s);

      bannerText.textContent = label;
      bannerDesc.textContent = updated ? `${dict.since} ${fmt(updated)} (${rel(updated)})` : '';

      const d = document.createElement('span');
      d.className = `dot ${cls}`;

      const txt = document.createElement('span');
      txt.textContent = label;

      chip.replaceChildren(d, txt);
    }

    function renderComponents(list){
      const dict = t();
      componentsEl.innerHTML = '';

      if(!list || !list.length){
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `<span class="sig status-maint"></span>
          <div class="item-main">
            <div class="item-title">${esc(dict.noComponents)}</div>
            <div class="item-sub">${esc(dict.emptyList)}</div>
          </div>
          <span class="badge">—</span>`;
        componentsEl.appendChild(row);
        return;
      }

      list.forEach(c=>{
        const row = document.createElement('div');
        row.className = 'item';

        const sig = document.createElement('span');
        sig.className = `sig ${compClass(c.status)}`;
        sig.title = labelComp(c.status);

        const main = document.createElement('div');
        main.className = 'item-main';

        const name = document.createElement('div');
        name.className = 'item-title';
        name.textContent = c.name ?? dict.noComponents;

        const sub = document.createElement('div');
        sub.className = 'item-sub';

        const up = (typeof c.uptime_90d === 'number')
          ? ` · ${dict.uptime90d}: ${c.uptime_90d.toFixed(2)}%`
          : '';

        sub.textContent = `${labelComp(c.status)}${up}`;

        main.appendChild(name);
        main.appendChild(sub);

        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = labelComp(c.status);

        row.appendChild(sig);
        row.appendChild(main);
        row.appendChild(badge);

        componentsEl.appendChild(row);
      });
    }

    function sevBadge(sev){
      const dict = t().sev;

      const w = document.createElement('span');
      w.className = 'pill';
      w.style.padding = '10px 12px';
      w.style.minHeight = '40px';

      const d = document.createElement('span');
      d.className = 'dot';

      const txt = document.createElement('span');
      txt.style.fontFamily = 'var(--mono)';
      txt.style.fontSize = '12px';
      txt.style.color = 'rgba(255,255,255,.78)';

      if(sev==='minor'){ d.classList.add('status-warn'); txt.textContent = dict.minor; }
      else if(sev==='major'){ d.classList.add('status-down'); txt.textContent = dict.major; }
      else if(sev==='critical'){ d.classList.add('status-down'); txt.textContent = dict.critical; }
      else if(sev==='maintenance'){ d.classList.add('status-maint'); txt.textContent = dict.maintenance; }
      else { d.classList.add('status-ok'); txt.textContent = dict.info; }

      w.replaceChildren(d,txt);
      return w;
    }

    function renderIncidents(list){
      const dict = t();
      incidentsEl.innerHTML = '';

      if(!list || list.length === 0){
        const e = document.createElement('div');
        e.className = 'inc';
        e.innerHTML = `<div class="inc-head"><span class="muted">${esc(dict.noIncidents)}</span></div>`;
        incidentsEl.appendChild(e);
        return;
      }

      list.sort((a,b)=>new Date(b.start)-new Date(a.start));

      list.forEach(inc=>{
        const box = document.createElement('div');
        box.className = 'inc';

        const head = document.createElement('div');
        head.className = 'inc-head';

        head.appendChild(sevBadge(inc.severity));

        const h3 = document.createElement('h3');
        h3.className = 'inc-title';
        h3.textContent = inc.title ?? 'Untitled';
        head.appendChild(h3);

        const meta = document.createElement('div');
        meta.className = 'inc-meta';
        const when = inc.end ? `${fmt(inc.start)} — ${fmt(inc.end)}` : `${fmt(inc.start)} · ${dict.ongoing}`;
        const aff  = inc.affected && inc.affected.length ? ` · ${dict.affected}: ${inc.affected.join(', ')}` : '';
        meta.textContent = `${when}${aff}`;
        head.appendChild(meta);

        box.appendChild(head);

        if(inc.updates && inc.updates.length){
          const details = document.createElement('details');
          details.open = true;

          const sum = document.createElement('summary');
          sum.textContent = dict.updates;
          details.appendChild(sum);

          const ul = document.createElement('ol');
          ul.className = 'updates';

          inc.updates.sort((a,b)=>new Date(b.time)-new Date(a.time));

          inc.updates.forEach(u=>{
            const li = document.createElement('li');

            const whenEl = document.createElement('time');
            const iso = new Date(u.time).toISOString();
            whenEl.dateTime = iso;
            whenEl.textContent = `${fmt(u.time)} (${rel(u.time)})`;

            const text = document.createElement('div');
            text.style.fontFamily = 'var(--mono)';
            text.style.fontSize = '12px';
            text.style.color = 'rgba(255,255,255,.78)';
            text.innerHTML = `<strong>${esc(labelUpd(u.status))}</strong>: ${esc(u.text)}`;

            li.appendChild(whenEl);
            li.appendChild(text);
            ul.appendChild(li);
          });

          details.appendChild(ul);
          box.appendChild(details);
        }

        incidentsEl.appendChild(box);
      });
    }

    function aggregate(data){
      return data.status || computeOverall(data.components || []);
    }

    function setBusy(b){
      inFlight = b;
      refreshBtn.disabled = b;
      refreshBtn.setAttribute("aria-busy", b ? "true" : "false");
    }

    async function loadData(){
      if(inFlight) return;
      setBusy(true);
      lastUpdatedEl.textContent = t().refreshing;

      try{
        if(ctrl) ctrl.abort();
        ctrl = new AbortController();

        const r = await fetch('status.json', { cache:'no-store', signal: ctrl.signal });
        if(!r.ok) throw new Error('http ' + r.status);

        const data = await r.json();
        lastData = data;

        applyOverall(aggregate(data), data.last_updated);
        renderComponents(data.components || []);
        renderIncidents(data.incidents || []);

        lastUpdatedEl.textContent = `${t().lastUpdate} ${fmt(data.last_updated || Date.now())}`;
      }catch(e){
        if(e && e.name === "AbortError") return;

        lastData = null;
        applyOverall('major');
        bannerDesc.textContent = t().failed;

        componentsEl.innerHTML = '';
        incidentsEl.innerHTML = `<div class="inc"><div class="inc-head"><span class="muted">${esc(t().couldNotLoad)}</span></div></div>`;
        lastUpdatedEl.textContent = t().error;
      }finally{
        setBusy(false);
      }
    }

    function rerender(){
      applyI18n();
      if(lastData){
        applyOverall(aggregate(lastData), lastData.last_updated);
        renderComponents(lastData.components || []);
        renderIncidents(lastData.incidents || []);
        lastUpdatedEl.textContent = `${t().lastUpdate} ${fmt(lastData.last_updated || Date.now())}`;
      }
    }

    refreshBtn.addEventListener('click', loadData);

    let iv = null;
    autoRefresh.addEventListener('change', ()=>{
      if(iv){ clearInterval(iv); iv = null; }
      if(autoRefresh.checked){
        loadData();
        iv = setInterval(loadData, 60000);
      }
    });

    document.addEventListener("visibilitychange", ()=>{
      if(document.hidden && iv){
        clearInterval(iv);
        iv = null;
      }else if(!document.hidden && autoRefresh.checked && !iv){
        iv = setInterval(loadData, 60000);
      }
    });

    langBtn.addEventListener("click", ()=>{
      lang = (lang === "ru") ? "en" : "ru";
      localStorage.setItem("lang", lang);
      rerender();
    });

    applyI18n();
    loadData();
  })();
  </script>
</body>
</html>
